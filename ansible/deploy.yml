---
- name: Deploy CloudSecure Application
  hosts: cloudsecure_instances
  become: yes

  vars:
    app_dir: /opt/cloudsecure
    docker_compose_version: "2.29.2"
    node_version: "18.x"
    vault_db_user: "{{ lookup('env', 'DB_USER') | default('your_db_username', true) }}"
    vault_db_password: "{{ lookup('env', 'DB_PASSWORD') | default('your_db_password', true) }}"
    vault_mongo_user: "{{ lookup('env', 'MONGO_USER') | default('your_mongo_username', true) }}"
    vault_mongo_password: "{{ lookup('env', 'MONGO_PASSWORD') | default('your_mongo_password', true) }}"
    vault_jwt_secret: "{{ lookup('env', 'JWT_SECRET') | default('your_jwt_secret', true) }}"
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_KEY') }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') }}"

  pre_tasks:
  - name: Ensure SSH connection is stable
    wait_for_connection:
      delay: 5
      timeout: 120

  - name: Fetch secrets from AWS Secrets Manager
    ansible.builtin.set_fact:
      vault_db_user: "admin"
      vault_db_password: "adminpassword"
      vault_mongo_user: "mongo-user"
      vault_mongo_password: "mongo-password"
      vault_jwt_secret: "your_jwt_secret"
    # Comment out the actual fetch
    # ansible.builtin.shell: aws secretsmanager get-secret-value --secret-id cloudsecure-secrets --query SecretString --output text
    # register: secrets
    # delegate_to: localhost

  tasks:
  - name: Add Node.js 18.x repository
    shell: curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -

  - name: Install required packages
    yum:
      name:
      - docker
      - git
      - python3
      - python3-pip
      - nodejs
      state: present

  - name: Install Docker Compose (legacy binary)
    get_url:
      url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-{{ ansible_architecture }}"
      dest: /usr/local/bin/docker-compose
      mode: '0755'
      force: yes

  - name: Start and enable Docker service
    service:
      name: docker
      state: started
      enabled: yes
    register: docker_service
    failed_when: docker_service.state != 'started'

  - name: Add current user to docker group
    user:
      name: "{{ ansible_user }}"
      groups: docker
      append: yes
    register: user_update

  - name: Reset SSH connection to apply group changes
    meta: reset_connection
    when: user_update.changed

  - name: Create application directory
    file:
      path: "{{ app_dir }}"
      state: directory
      mode: '0755'
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"

  - name: Copy application files (excluding node_modules)
    ansible.posix.synchronize:
      src: ../app/
      dest: "{{ app_dir }}/app/"
      mode: push
      rsync_opts:
      - "--exclude=node_modules/**"
      - "--chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r"
    register: copy_result
    retries: 3
    delay: 5
    until: copy_result is succeeded

  - name: Copy docker-compose file
    copy:
      src: ../docker-compose.yml
      dest: "{{ app_dir }}/docker-compose.yml"
      mode: '0644'

  - name: Create client environment file
    copy:
      content: |
        REACT_APP_API_URL=http://localhost:3000
        NODE_ENV=development
      dest: "{{ app_dir }}/app/client/.env"
      mode: '0644'

  - name: Create server environment file
    copy:
      content: |
        PORT=3000
        NODE_ENV=development
        DB_HOST=db-service
        DB_USER={{ vault_db_user }}
        DB_PASSWORD={{ vault_db_password }}
        DB_NAME=security_ai
        REDIS_HOST=redis-service
        MONGODB_URI=mongodb://{{ vault_mongo_user }}:{{ vault_mongo_password }}@mongo-service:27017/cloudsecure?authSource=admin
        CLIENT_URL=http://localhost
        JWT_SECRET={{ vault_jwt_secret }}
      dest: "{{ app_dir }}/app/server/.env"
      mode: '0644'

  - name: Wait for Docker to be ready
    command: docker info
    retries: 5
    delay: 5
    register: docker_ready
    until: docker_ready.rc == 0

  - name: Remove legacy Docker Compose binary if exists
    file:
      path: /usr/local/bin/docker-compose
      state: absent

  - name: Create directory for Docker CLI plugins
    file:
      path: /usr/local/lib/docker/cli-plugins
      state: directory
      mode: '0755'

  - name: Download Docker Compose v2 plugin binary
    get_url:
      url: "https://github.com/docker/compose/releases/download/v{{ docker_compose_version }}/docker-compose-linux-{{ ansible_architecture }}"
      dest: /usr/local/lib/docker/cli-plugins/docker-compose
      mode: '0755'
      force: yes

  - name: Run Docker Compose
    shell: |
      cd {{ app_dir }}
      ECR_REPOSITORY_URI=security-ai docker compose up -d --build
    environment:
      COMPOSE_HTTP_TIMEOUT: "200"
      ECR_REPOSITORY_URI: "security-ai"

  - name: Check if containers are running
    command: docker compose ps
    args:
      chdir: "{{ app_dir }}"
    register: container_status
    changed_when: false

  - name: Display container status
    debug:
      var: container_status.stdout_lines

  - name: Create backup directory
    file:
      path: "{{ app_dir }}/backups"
      state: directory
      mode: '0755'

  - name: Check operating system
    command: cat /etc/os-release
    register: os_release
    changed_when: false

  - name: Determine firewall service
    set_fact:
      firewall_service: "{{ 'firewalld' if 'Fedora' in os_release.stdout or 'CentOS' in os_release.stdout or 'Red Hat' in os_release.stdout else 'iptables' }}"

  - name: Check if firewalld is installed
    command: which firewalld
    register: firewalld_check
    ignore_errors: yes
    changed_when: false

  - name: Ensure firewalld is started (if available)
    service:
      name: firewalld
      state: started
      enabled: yes
    when: firewall_service == 'firewalld' and firewalld_check.rc == 0
    ignore_errors: yes

  - name: Configure iptables on Amazon Linux
    block:
      - name: Install iptables-services if needed
        yum:
          name: iptables-services
          state: present
        
      - name: Enable required ports with iptables
        shell: |
          iptables -A INPUT -p tcp --dport 80 -j ACCEPT
          iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
          iptables-save > /etc/sysconfig/iptables
        ignore_errors: yes
    when: firewall_service == 'iptables' or firewalld_check.rc != 0
    ignore_errors: yes

  - name: Inform user about AWS Security Group usage
    debug:
      msg: "Note: AWS EC2 instances typically use Security Groups for firewall management. Make sure your security group allows traffic on required ports."

  - name: Install cronie to provide crontab command
    yum:
      name: cronie
      state: present

  - name: Setup backup cron job
    cron:
      name: "Backup databases"
      minute: "0"
      hour: "0"
      job: "cd {{ app_dir }} && docker compose exec -T db-service mysqldump -u {{ vault_db_user }} -p{{ vault_db_password }} security_ai > {{ app_dir }}/backups/mysql_backup_$(date +\\%Y\\%m\\%d).sql && docker compose exec -T mongo-service mongodump --uri='mongodb://{{ vault_mongo_user }}:{{ vault_mongo_password }}@mongo-service:27017/cloudsecure?authSource=admin' --archive > {{ app_dir }}/backups/mongo_backup_$(date +\\%Y\\%m\\%d).archive"

  - name: Setup log rotation
    copy:
      content: |
        /var/lib/docker/containers/*/*.log {
            rotate 7
            daily
            compress
            missingok
            delaycompress
            copytruncate
        }
      dest: /etc/logrotate.d/docker-container-logs
      mode: '0644'
    notify: Run logrotate

  - name: Ensure Docker Compose environment variables are set
    copy:
      content: |
        ECR_REPOSITORY_URI=security-ai
      dest: "{{ app_dir }}/.env"
      mode: '0644'

  handlers:
  - name: Run logrotate
    command: logrotate /etc/logrotate.d/docker-container-logs